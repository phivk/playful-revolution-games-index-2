# Phase 4: Deployment - Research

**Researched:** 2026-02-22
**Domain:** Next.js static export to Vercel with Decap CMS production OAuth setup
**Confidence:** HIGH

## Summary

Phase 4 requires exporting a Next.js application with an embedded Decap CMS to a static build and deploying it to Vercel. The project is already configured for static export (`output: 'export'` in next.config.ts), and Decap CMS is embedded via CDN in `/public/admin/`. The main implementation work involves:

1. **Static Build Setup:** Already complete (verified `next.config.ts` has `output: 'export'` and unoptimized images)
2. **Decap CMS OAuth for Production:** Requires a custom serverless function to handle GitHub OAuth authentication, replacing Netlify's built-in git-gateway service
3. **Vercel Configuration:** Setting environment variables for GitHub OAuth credentials and configuring the build/deploy pipeline
4. **Post-Deploy Manual Steps:** User will connect the repository in Vercel dashboard and trigger the first deployment

**Primary recommendation:** Use Vercel serverless functions (API routes in the app directory) to implement GitHub OAuth handling, configure environment variables in Vercel dashboard, and document the manual GitHub OAuth app creation and Vercel project setup steps.

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions
- Deploy to **Vercel** (not GitHub Pages)
- New Vercel project — repo not yet connected
- Auto-deploy on push to main (standard Vercel behavior)
- Small team of editors with GitHub accounts need `/admin` access
- GitHub OAuth for authentication
- `/admin` URL is publicly accessible — GitHub OAuth is the only access control needed

### Claude's Discretion
- Whether to use `output: 'export'` (already decided: YES, already configured)
- OAuth handler implementation (serverless function approach recommended)
- Any pre-build steps needed for data/content

### Deferred Ideas (OUT OF SCOPE)
- None — discussion stayed within phase scope
</user_constraints>

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| DEPL-01 | Static site build/export | Next.js `output: 'export'` already configured; build produces HTML/CSS/JS to `/out` directory. Vercel detects static sites automatically. |
| DEPL-02 | Deploy to Vercel or GH Pages | Vercel selected; serverless functions needed for GitHub OAuth handling; environment variables for OAuth credentials; standard Vercel deploy pipeline. |
</phase_requirements>

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Next.js | 16.1.6 | Framework (static export mode) | Already in project; `output: 'export'` stable and recommended |
| React | 19.2.3 | UI library | Already in project; works with static export |
| Decap CMS | 3.0+ (via CDN) | Headless CMS with git-based backend | Already configured via CDN in `/public/admin/` |
| Vercel | Latest | Static site hosting and serverless functions | Official Next.js creator; zero-config support for static exports |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| GitHub OAuth | GitHub App Flow | Authentication for CMS access | Small team with GitHub accounts; no external identity service needed |
| Vercel Serverless Functions | Node.js runtime | OAuth token exchange handler | Required to bridge GitHub OAuth (requires server) with static site |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Custom OAuth handler | Netlify Identity (via git-gateway) | Netlify is vendor-specific; this project is static-export on Vercel |
| Vercel serverless | AWS Lambda, Cloudflare Workers | Vercel keeps all infrastructure on one platform; simpler to configure |
| CDN Decap CMS | npm package (`decap-cms`) | CDN approach avoids webpack bundler issues with Next.js static export |

**Installation:**
No new npm packages needed. Decap CMS loads from CDN. Vercel OAuth handler is a single API route file.

## Architecture Patterns

### Recommended Project Structure

The project already follows this structure:
```
.
├── src/
│   ├── app/              # Next.js App Router pages
│   ├── components/       # React components
│   ├── data/            # Content data files
│   ├── hooks/           # Custom React hooks
│   └── types/           # TypeScript types
├── public/
│   ├── admin/
│   │   ├── index.html   # Decap CMS entry point (CDN-based)
│   │   └── config.yml   # CMS collections and fields configuration
│   └── images/          # Media folder for CMS uploads
├── out/                 # Static build output (generated by `next build`)
├── package.json
├── next.config.ts       # Already configured: output: 'export'
└── vercel.json          # (To be created) Vercel deployment config
```

For Phase 4, add:
```
api/
├── auth/
│   └── callback.ts      # GitHub OAuth callback handler (receives code, exchanges for token)
└── oauth/
    └── authorize.ts     # OAuth authorize endpoint (redirects to GitHub)
```

### Pattern 1: Vercel Serverless Function for OAuth

**What:** A Node.js API route that handles the OAuth token exchange with GitHub.

**When to use:** Any time you need to:
- Receive an OAuth `code` from the client after GitHub redirects back
- Exchange the code for a GitHub access token (server-side only, requires CLIENT_SECRET)
- Return the token to Decap CMS so it can authenticate subsequent git operations

**Why this pattern:** GitHub OAuth requires server-side code to handle the secret. Static sites can't do this directly, so Vercel serverless functions bridge the gap.

**Example (TypeScript):**
```typescript
// api/auth/callback.ts
// This receives the OAuth callback from GitHub
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const code = searchParams.get('code');
  const state = searchParams.get('state');

  if (!code) {
    return NextResponse.json({ error: 'No code provided' }, { status: 400 });
  }

  try {
    // Exchange code for token (requires CLIENT_SECRET, kept server-side)
    const response = await fetch('https://github.com/login/oauth/access_token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify({
        client_id: process.env.GITHUB_CLIENT_ID,
        client_secret: process.env.GITHUB_CLIENT_SECRET,
        code,
      }),
    });

    const data = await response.json();

    if (data.error) {
      return NextResponse.json({ error: data.error }, { status: 400 });
    }

    // Return token to Decap CMS
    return NextResponse.json({
      token: data.access_token,
      token_type: data.token_type || 'bearer',
    });
  } catch (error) {
    return NextResponse.json(
      { error: 'Token exchange failed' },
      { status: 500 }
    );
  }
}
```

Source: [Decap CMS External OAuth Clients](https://decapcms.org/docs/external-oauth-clients/)

### Pattern 2: Decap CMS Config for External OAuth

**What:** Configure Decap CMS to use your custom OAuth handler instead of Netlify Identity.

**When to use:** Always, when deploying to Vercel with git-gateway backend.

**Example (config.yml):**
```yaml
backend:
  name: git-gateway
  branch: main
  auth_endpoint: /api/oauth/authorize          # Route to start OAuth flow
  token_endpoint: /api/auth/callback           # Route to handle callback
  auth_type: github                             # OAuth provider type

media_folder: "public/images"
public_folder: "/images"

collections:
  - name: "games"
    label: "Games"
    # ... rest of config
```

Note: The current `config.yml` has `backend: name: git-gateway` but is missing the custom OAuth endpoint configuration. This will need to be updated.

Source: [Decap CMS Git Gateway Backend](https://decapcms.org/docs/git-gateway-backend/)

### Anti-Patterns to Avoid

- **Committing OAuth secrets to git:** CLIENT_SECRET must ONLY be in Vercel environment variables, never in code or .env files
- **Using npm `decap-cms` with Next.js static export:** The webpack bundler issues are well-documented. Keep the CDN approach.
- **Relying on Netlify for git-gateway without git-gateway server:** GitHub requires server-side OAuth handling; can't be done client-side
- **Forgetting `unoptimized: true` in next.config.ts:** With static export, image optimization requires custom loaders; default config will fail
- **Building in-source (not into `/out`):** Static export always uses `/out`; don't try to override this for Vercel compatibility

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| OAuth token exchange | Custom JWT/token system | GitHub OAuth via serverless function | GitHub OAuth is industry standard; custom auth exposes security risks |
| Static site hosting | Run your own server | Vercel or similar CDN | Hosting static assets is commodity; use a platform |
| CMS interface | Custom admin panels | Decap CMS | Building admin UIs is complex; Decap solves this |
| Environment secrets | .env.local committed to git | Vercel environment variables dashboard | Environment variables in Vercel dashboard are encrypted at rest |

**Key insight:** The phase boundary is deployment, not auth infrastructure. Use GitHub OAuth (standard), Vercel (serverless), and Decap CMS (admin UI) to avoid building infrastructure.

## Common Pitfalls

### Pitfall 1: Forgetting to Set Environment Variables in Vercel

**What goes wrong:** OAuth handler code references `process.env.GITHUB_CLIENT_ID` and `process.env.GITHUB_CLIENT_SECRET`, but these variables don't exist in Vercel dashboard. Deployments fail or `/api/auth/callback` returns 500 errors.

**Why it happens:** Environment variables must be configured in Vercel's dashboard BEFORE the first deploy. There's no .env file in production.

**How to avoid:**
1. Create GitHub OAuth app first (get CLIENT_ID and SECRET)
2. Add both variables to Vercel project settings (Settings > Environment Variables)
3. Set them for "Production" environment
4. Redeploy (or trigger a redeployment) after setting variables

**Warning signs:**
- OAuth callback silently fails
- 500 error from `/api/auth/callback`
- Decap CMS error: "Could not authenticate with GitHub"

Source: [Vercel Environment Variables](https://vercel.com/docs/environment-variables)

### Pitfall 2: Config.yml Backend Configuration Mismatch

**What goes wrong:** `config.yml` still has `backend: name: git-gateway` with no `auth_endpoint` or `token_endpoint`. Decap CMS tries to use Netlify Identity or old git-gateway defaults, fails to authenticate.

**Why it happens:** The current config.yml is correct for git-gateway, but missing the custom OAuth endpoints. This is easy to overlook when migrating from Netlify.

**How to avoid:**
- Update `config.yml` to specify custom OAuth endpoints (`auth_endpoint: /api/oauth/authorize`, `token_endpoint: /api/auth/callback`)
- Test locally: run `npm run dev` and check that `/api/oauth/authorize` and `/api/auth/callback` exist
- Verify Decap CMS loads without errors in browser console

**Warning signs:**
- Decap CMS login button doesn't redirect to GitHub
- "Failed to authenticate" message in CMS
- Browser console shows 404 for `/oauth` or `/auth/callback`

### Pitfall 3: Decap CMS CDN vs npm Bundler Issues

**What goes wrong:** Developer installs `decap-cms` via npm, Next.js webpack bundler fails with "Cannot find module 'node:url'" or similar Node.js module errors.

**Why it happens:** Decap CMS npm package has dependencies on Node.js modules. With static export and webpack, these modules can't be bundled.

**How to avoid:**
- Keep Decap CMS loaded from CDN (current setup is correct)
- If you need to customize Decap behavior, extend via CMS config, not npm packages
- Never install `decap-cms` or `netlify-cms` to npm

**Warning signs:**
- Build fails with "Cannot find module 'node:url'" or similar
- `/admin` page doesn't load
- Webpack bundler errors during `npm run build`

Source: [Decap CMS Next.js Documentation](https://decapcms.org/docs/nextjs/)

### Pitfall 4: Static Export Limitations Ignored

**What goes wrong:** Developer adds API routes, dynamic redirects, or ISR (Incremental Static Regeneration) to the site. Build succeeds locally but fails on Vercel or produced files don't work as expected.

**Why it happens:** `output: 'export'` disables these features. They require a Node.js server.

**How to avoid:**
- Remember: `output: 'export'` = static files only, no server runtime
- For the CMS OAuth handler: use `/api/` routes, but understand these are only available in Vercel environment, NOT in static `/out` build
- For content changes: git commits trigger Vercel rebuilds; there's no "publish without rebuild"

**Warning signs:**
- Build logs: "API routes are not supported with output: export"
- Dynamic routes returning 404 instead of generating static files
- Using `getServerSideProps` or server-only imports in page components

Source: [Next.js Static Exports - Unsupported Features](https://nextjs.org/docs/pages/building-your-application/deploying/static-exports)

### Pitfall 5: Public Folder Files Not Deployed

**What goes wrong:** New images uploaded via Decap CMS to `/public/images/` don't appear in the deployed site.

**Why it happens:** The static build (`npm run build` → `/out`) doesn't automatically include new files created after initial build. Only files in `/public` at build time are copied.

**How to avoid:**
- Keep the pattern: Decap CMS uploads to `/public/images/` → git commit → Vercel rebuild → new images included in `/out`
- Never manually add files to `/out`; it's regenerated on each build
- Images must be committed to git; there's no "CDN upload" with this architecture

**Warning signs:**
- Images uploaded in CMS appear in preview but not on live site
- Images exist in GitHub but missing from deployed site
- Vercel deploy shows "no changes" but you added images

## Code Examples

Verified patterns from official sources and community projects:

### GitHub OAuth App Creation

1. Go to GitHub Settings > Developer Settings > [OAuth Apps](https://github.com/settings/developers)
2. Click "New OAuth App"
3. Fill in:
   - **Application name:** "Playful Revolution Games CMS"
   - **Homepage URL:** Your future Vercel URL (e.g., `https://games-index.vercel.app`)
   - **Authorization callback URL:** `https://games-index.vercel.app/api/auth/callback`
4. Copy **Client ID** and **Client Secret**

### Vercel Serverless Function: OAuth Authorize Route

```typescript
// api/oauth/authorize.ts
// Redirects user to GitHub login
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const clientId = process.env.GITHUB_CLIENT_ID;
  const redirectUri = `${process.env.VERCEL_URL ? 'https://' + process.env.VERCEL_URL : 'http://localhost:3000'}/api/auth/callback`;
  const state = Math.random().toString(36).substring(7); // Simple state for CSRF protection

  const authorizeUrl = new URL('https://github.com/login/oauth/authorize');
  authorizeUrl.searchParams.append('client_id', clientId || '');
  authorizeUrl.searchParams.append('redirect_uri', redirectUri);
  authorizeUrl.searchParams.append('scope', 'repo user:email'); // Scopes needed for git operations
  authorizeUrl.searchParams.append('state', state);

  return NextResponse.redirect(authorizeUrl.toString());
}
```

Source: [GitHub OAuth Documentation](https://docs.github.com/en/developers/apps/building-oauth-apps/creating-an-oauth-app)

### Decap CMS Config Update for External OAuth

```yaml
# public/admin/config.yml
backend:
  name: git-gateway
  branch: main
  auth_endpoint: /api/oauth/authorize
  token_endpoint: /api/auth/callback
  auth_type: github

media_folder: "public/images"
public_folder: "/images"

collections:
  - name: "games"
    label: "Games"
    folder: "content/games"
    create: true
    delete: true
    slug: "{{slug}}"
    fields:
      - { label: "ID", name: "id", widget: "uuid" }
      - { label: "Slug", name: "slug", widget: "string" }
      # ... rest of fields
```

Source: [Decap CMS Configuration](https://decapcms.org/docs/configuration-options/)

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Netlify-hosted CMS with Identity | External OAuth handlers (serverless) | 2023-2024 | Decouples CMS from hosting platform; Vercel became standard for Next.js |
| `next export` command | `output: 'export'` in next.config.js | Next.js 13.3 | Unified configuration syntax; more explicit |
| Manually deploying built files | Git push → Vercel auto-deploy | Always | Standard modern practice; no manual upload |

**Deprecated/outdated:**
- **Netlify CMS:** Rebranded to Decap CMS (2023); old docs still exist but point to Decap
- **next export command:** Replaced by `output: 'export'` config (Next.js 13.3+)
- **Static hosting on S3/Azure:** Vercel's zero-config makes these obsolete for Next.js projects

## Open Questions

1. **Pre-build data generation?**
   - What we know: Decap CMS stores content in `/content/games/` folder as markdown files committed to git
   - What's unclear: Whether any data preprocessing is needed before static build (e.g., generating sitemap, JSON feed, image optimization)
   - Recommendation: Start without pre-build steps. If needed (SEO sitemaps, etc.), add during implementation. Next.js can generate these at build time using server components or static route handlers.

2. **Image optimization post-static export?**
   - What we know: next.config.ts has `images: { unoptimized: true }`
   - What's unclear: Whether Vercel's built-in image optimization works with static exports, or if all images must be optimized pre-build
   - Recommendation: Current config is safe (unoptimized images). Images in `/public` are served as-is. Consider adding a build step to optimize if performance issues arise.

3. **Vercel build caching strategy?**
   - What we know: Vercel caches dependencies and build artifacts by default
   - What's unclear: How caching interacts with new content from Decap CMS git commits
   - Recommendation: Vercel handles this automatically; cache is invalidated on new commits. No configuration needed.

4. **Custom domain setup?**
   - What we know: Phase 4 goal is "live at public URL"
   - What's unclear: Who sets up custom domain (e.g., playful-games.example.com) and when
   - Recommendation: Phase 4 focuses on Vercel URL setup. Custom domain is user responsibility post-deployment.

## Sources

### Primary (HIGH confidence)

- [Next.js Documentation: Static Exports](https://nextjs.org/docs/pages/building-your-application/deploying/static-exports) - Configuration, supported features, unsupported features, deployment
- [Decap CMS Documentation: External OAuth Clients](https://decapcms.org/docs/external-oauth-clients/) - How to implement custom OAuth handlers with GitHub
- [Decap CMS Documentation: Git Gateway Backend](https://decapcms.org/docs/git-gateway-backend/) - Configuration and authentication flow
- [Vercel Documentation: Environment Variables](https://vercel.com/docs/environment-variables) - Setting and managing secrets in production
- [GitHub OAuth Apps Documentation](https://docs.github.com/en/developers/apps/building-oauth-apps/creating-an-oauth-app) - Creating OAuth apps and token exchange

### Secondary (MEDIUM confidence - verified with official sources)

- [GitHub Community Projects: daresaydigital/decap-cms-oauth](https://github.com/daresaydigital/decap-cms-oauth) - Ready-made example of Decap CMS OAuth on Vercel
- [GitHub Community Projects: yardstick-codebase/decap-cms-oauth](https://github.com/yardstick-codebase/decap-cms-oauth) - Alternative Vercel serverless OAuth implementation
- [Decap CMS Documentation: Next.js Integration](https://decapcms.org/docs/nextjs/) - Next.js-specific setup, CDN vs npm package guidance

### Tertiary (Information sources, verified patterns)

- [Vercel Knowledge Base: Reducing Build Time](https://vercel.com/kb/guide/how-do-i-reduce-my-build-time-with-next-js-on-vercel) - Build optimization for Next.js
- [Vercel Blog: Next 3.0 Preview - Static Exports](https://vercel.com/blog/next3-preview) - Future direction of static exports

## Metadata

**Confidence breakdown:**

- **Standard Stack:** HIGH - Verified with official Next.js docs, Decap CMS docs, Vercel docs. Current project setup confirmed.
- **Architecture (Static Export + OAuth):** HIGH - Multiple official sources confirm static export support, community projects prove OAuth handler pattern works.
- **OAuth Implementation:** HIGH - GitHub OAuth flow documented by GitHub, Decap CMS specifies endpoints needed, community examples available.
- **Pitfalls:** MEDIUM-HIGH - Most come from official docs. Some (like Decap CDN vs npm) from verified community reports.
- **Vercel Configuration:** HIGH - Official Vercel documentation is authoritative and current.

**Research date:** 2026-02-22
**Valid until:** 2026-04-01 (Next.js and Vercel are stable; OAuth patterns don't change frequently)
