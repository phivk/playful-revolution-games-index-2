---
phase: 04-deployment
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - vercel.json
  - .env.local.example
  - .gitignore
autonomous: true
requirements: [DEPL-01, DEPL-02]

must_haves:
  truths:
    - "Running `npm run build` produces a clean static export in `/out` without errors"
    - "A `vercel.json` file exists that configures the build command, output directory, and HTTP security headers"
    - "Environment variable names are documented in `.env.local.example` so the user knows what to set in Vercel"
    - "`.env.local` is in `.gitignore` so secrets are never committed"
  artifacts:
    - path: "vercel.json"
      provides: "Vercel deployment config (build command, output dir, headers)"
    - path: ".env.local.example"
      provides: "Documentation of required env vars for GitHub OAuth"
  key_links:
    - from: "vercel.json"
      to: "npm run build"
      via: "buildCommand field"
      pattern: "\"buildCommand\".*next build"
    - from: "vercel.json"
      to: "out/"
      via: "outputDirectory field"
      pattern: "\"outputDirectory\".*out"
---

<objective>
Verify the static build works and create Vercel deployment configuration.

Purpose: Establish that the existing static export configuration is sound, and create the `vercel.json` config Vercel needs to build and serve the site correctly. Document the environment variables the user must set in Vercel dashboard before OAuth works.

Output: `vercel.json`, `.env.local.example`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deployment/04-CONTEXT.md
@.planning/phases/04-deployment/04-RESEARCH.md
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify static build and create vercel.json</name>
  <files>vercel.json</files>
  <action>
    First, run `npm run build` to confirm the static export produces `/out` without errors. The build should already work because `next.config.ts` has `output: 'export'` and `images: { unoptimized: true }`.

    If the build fails, diagnose and fix the error (common causes: missing `generateStaticParams` on dynamic routes, server-only imports in page components).

    After a successful build, create `vercel.json` at the project root with:

    ```json
    {
      "buildCommand": "npm run build",
      "outputDirectory": "out",
      "headers": [
        {
          "source": "/admin/(.*)",
          "headers": [
            { "key": "X-Frame-Options", "value": "SAMEORIGIN" },
            { "key": "X-Content-Type-Options", "value": "nosniff" }
          ]
        },
        {
          "source": "/(.*)",
          "headers": [
            { "key": "X-Content-Type-Options", "value": "nosniff" },
            { "key": "Referrer-Policy", "value": "strict-origin-when-cross-origin" }
          ]
        }
      ]
    }
    ```

    Note: Do NOT add `rewrites` or `routes` — the static export serves files from `/out` directly. The `/api/*` OAuth routes are handled separately in Plan 02.
  </action>
  <verify>
    1. `npm run build` exits with code 0 and produces files in `/out`
    2. `ls out/` shows HTML files (index.html, game/, admin/, etc.)
    3. `cat vercel.json` shows valid JSON with buildCommand, outputDirectory, and headers
    4. `node -e "JSON.parse(require('fs').readFileSync('vercel.json','utf8'))"` exits without error (valid JSON)
  </verify>
  <done>
    - `npm run build` succeeds without errors
    - `out/` directory exists with static HTML/CSS/JS files
    - `vercel.json` exists at project root with correct buildCommand (`npm run build`), outputDirectory (`out`), and security headers for `/admin/` and all routes
  </done>
</task>

<task type="auto">
  <name>Task 2: Document environment variables and protect secrets</name>
  <files>.env.local.example, .gitignore</files>
  <action>
    Create `.env.local.example` at the project root documenting the GitHub OAuth credentials needed for Decap CMS in production. This file is safe to commit — it contains no real secrets, only placeholder values and instructions.

    ```bash
    # GitHub OAuth App credentials for Decap CMS authentication
    # Create a GitHub OAuth App at: https://github.com/settings/developers
    # Set Authorization callback URL to: https://YOUR-VERCEL-DOMAIN.vercel.app/api/auth/callback
    #
    # After creating the app, add these values to:
    # Vercel Dashboard > Your Project > Settings > Environment Variables
    # Set scope to "Production" for both variables.
    #
    # Do NOT put real values in this file — use Vercel's dashboard for secrets.

    GITHUB_CLIENT_ID=your_github_oauth_app_client_id
    GITHUB_CLIENT_SECRET=your_github_oauth_app_client_secret
    ```

    Then check `.gitignore` and ensure it contains `.env.local` (it almost certainly does from the Next.js default, but verify). If not, add `.env.local` to `.gitignore`.
  </action>
  <verify>
    1. `cat .env.local.example` shows the two variables (GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET) with clear instructions
    2. `grep -q '.env.local' .gitignore && echo "protected" || echo "MISSING"` outputs "protected"
    3. No real secrets are in `.env.local.example` (values are placeholder strings)
  </verify>
  <done>
    - `.env.local.example` exists at project root with GITHUB_CLIENT_ID and GITHUB_CLIENT_SECRET placeholders plus setup instructions
    - `.gitignore` includes `.env.local` so real credentials are never committed
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `out/` directory is populated with static site files
3. `vercel.json` is valid JSON parseable by Node.js
4. `.env.local.example` lists both required OAuth env vars with instructions
5. `.gitignore` protects `.env.local`
</verification>

<success_criteria>
- Static build produces `/out` successfully
- `vercel.json` tells Vercel to run `npm run build` and serve `out/`
- Security headers configured for admin and all routes
- Developer onboarding for env vars is self-explanatory from `.env.local.example`
</success_criteria>

<output>
After completion, create `.planning/phases/04-deployment/04-01-SUMMARY.md`
</output>
